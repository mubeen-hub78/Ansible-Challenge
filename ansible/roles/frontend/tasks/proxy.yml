- name: Configure Nginx with HTTP and TCP proxy for Netdata
  copy:
    dest: /etc/nginx/nginx.conf
    content: |
      worker_processes auto;

      events { worker_connections 1024; }

      http {
          server {
              listen 80;

              location / {
                  root /usr/share/nginx/html;
                  index index.html index.htm;
              }
          }
      }

      stream {
          upstream netdata_backend {
              server {{ hostvars[groups['backend'][0]].ansible_host }}:19999;
          }

          server {
              listen 19999;
              proxy_pass netdata_backend;
          }
      }
  notify: restart nginx
